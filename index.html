<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resurgence Map Calculator</title>
    <style>
        body { 
            display: flex; margin: 0; height: 100vh; width: 100vw; 
            background: #1a1a1a; color: #ffffff; font-family: sans-serif; 
            overflow: hidden; 
        }
        #sidebar { 
            width: 280px; min-width: 280px; background: #252525; padding: 20px; 
            border-right: 1px solid #444; display: flex; flex-direction: column; gap: 18px; z-index: 100;
            align-items: center;
        }
        h2 { 
            margin: 0; font-size: 2.5rem; color: #6AD44C; text-transform: uppercase; letter-spacing: 2px; line-height: 1;
            text-align: center;
            width: 100%;
        }
        .author { font-size: 0.75rem; color: #888; margin-bottom: 10px; font-weight: bold; text-align: center; width: 100%; }
        
        .button-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .control-btn { 
            padding: 12px; cursor: pointer; background: #444; color: white; 
            border: none; border-radius: 6px; font-weight: bold; width: 90%; max-width: 220px; text-transform: uppercase; 
            margin: 0 auto;
            display: block;
            font-size: 1.09rem;
        }
        .control-btn:hover, .control-btn:active { background: #555; }

        #cal-info { 
            font-size: 0.85rem; padding: 15px; background: #000; color: #6AD44C; 
            border-radius: 6px; min-height: 180px; border: 1px solid #6AD44C; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; text-align: center; overflow-y: auto;
            line-height: 1.6; font-family: 'Courier New', Courier, monospace;
            box-shadow: inset 0 0 10px rgba(106, 212, 76, 0.2);
            width: 100%;
            max-width: 250px;
            margin: 0 auto;
        }

        hr { border: 0; border-top: 1px solid #444; margin: 5px 0; width: 80%; }

        /* --- MOBILE --- */
        @media (max-width: 750px) {
            body {
                flex-direction: column;
                height: 100vh;
                width: 100vw;
            }
            #sidebar {
                width: 100vw;
                min-width: unset;
                border-right: none;
                border-bottom: 1px solid #444;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                flex-wrap: nowrap;
                padding: 18px 6px 14px 6px;
                font-size: 1em;
                gap: 14px;
                overflow-x: auto;
                box-sizing: border-box;
            }
            #sidebar h2 {
                font-size: 2rem;
            }
            #cal-info {
                min-height: unset;
                padding: 11px 6px;
                font-size: 0.97em;
                max-width: 295px;
                margin: 0 auto 0 auto;
                flex: none;
                width: 100%;
            }
            .button-group {
                width: 100%;
                gap: 12px;
                margin-bottom: 0;
            }
            .control-btn {
                padding: 11px 7px;
                font-size: 1.07em;
                min-width: 120px;
                max-width: 310px;
                width: 92vw;
                margin-bottom: 0;
                margin-top: 0;
                border-radius: 7px;
            }
            hr {
                width: 90%;
                margin: 6px auto;
            }
            .author { display: none; }
        }
        #map-viewport { flex-grow: 1; overflow: hidden; background: #000; position: relative; touch-action: none; }
        canvas { display: block; touch-action: none; }
        /* Objective Menu Styles */
        .obj-list { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .obj-btn {
            background: none; border: none; padding: 4px; cursor: pointer;
            text-decoration: underline; text-transform: uppercase; font-weight: bold;
            font-family: 'Courier New', Courier, monospace; font-size: 0.9rem;
            transition: transform 0.1s;
        }
        .obj-btn:hover { transform: scale(1.1); filter: brightness(1.3); }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>RMC</h2>
    <div class="author">Made By Phoxphor</div>

    <div class="button-group">
        <button class="control-btn" style="background: #4e4010; color: #ffff00;" onclick="addAirdrop()">Add Airdrop</button>
        <button class="control-btn" style="background: #2b4d24; color: #6AD44C;" onclick="findNearest()">Find Nearest</button>
        <button class="control-btn" onclick="toggleVisibility()">Toggle Icons</button>
    </div>
    <hr>
    <div id="cal-info">WAITING FOR INPUT...</div>
    <hr>
</div>

<div id="map-viewport">
    <canvas id="mapCanvas"></canvas>
</div>

<script src="index.js"></script>
<script>
    // --- Simple Touch & Pinch Zoom Handler ---
    // Only enable overrides on mobile/touch devices

    (function() {
        const canvas = document.getElementById('mapCanvas');
        if (!canvas) return;

        let lastDist = 0;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Stops phone from scrolling page
            
            if (e.touches.length === 2) {
                const t1 = e.touches[0];
                const t2 = e.touches[1];
                lastDist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
            } else if (e.touches.length === 1) {
                isDragging = true;
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();

            if (e.touches.length === 2) {
                // PINCH ZOOM
                const t1 = e.touches[0];
                const t2 = e.touches[1];
                const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
                const midX = (t1.clientX + t2.clientX) / 2;
                const midY = (t1.clientY + t2.clientY) / 2;

                const r = canvas.getBoundingClientRect();
                const focalX = midX - r.left;
                const focalY = midY - r.top;

                const mapPoint = screenToMap(focalX, focalY);
                const delta = dist / lastDist;
                
                targetView.zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, targetView.zoom * delta));
                view.zoom = targetView.zoom; // Instant update

                targetView.x = focalX - mapPoint.x * targetView.zoom;
                targetView.y = focalY - mapPoint.y * targetView.zoom;
                
                lastDist = dist;
                clampView();
            } else if (e.touches.length === 1 && isDragging) {
                // DRAG
                const dx = e.touches[0].clientX - lastMouseX;
                const dy = e.touches[0].clientY - lastMouseY;

                targetView.x += dx;
                targetView.y += dy;
                view.x = targetView.x; // Instant update
                view.y = targetView.y;

                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;

                // Update HUD Coords
                const r = canvas.getBoundingClientRect();
                mouseX = e.touches[0].clientX - r.left;
                mouseY = e.touches[0].clientY - r.top;
                
                clampView();
            }
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            if (e.touches.length === 0) {
                isDragging = false;
                // Handle Tap (Marker Placement)
                if (e.changedTouches.length === 1) {
                    const r = canvas.getBoundingClientRect();
                    const tx = e.changedTouches[0].clientX - r.left;
                    const ty = e.changedTouches[0].clientY - r.top;
                    
                    mouseX = tx;
                    mouseY = ty;
                    const mapPos = screenToMap(tx, ty);

                    if (isWaitingForLocationClick) {
                        const myC = getGameCoords(mapPos.x, mapPos.y);
                        const playerMark = { x: mapPos.x, y: mapPos.y, type: 'PLAYER', label: "Me", gx: myC.x, gy: myC.y, timestamp: Date.now() };
                        markers = markers.filter(mark => mark.type !== 'PLAYER');
                        markers.push(playerMark);
                        isWaitingForLocationClick = false;
                        if (pendingAirdropCalculation) {
                            const lastDrop = markers.filter(mark => mark.type === 'AIRDROP').pop();
                            if (lastDrop) updateTacticalHUD(playerMark, lastDrop);
                            pendingAirdropCalculation = false;
                        } else {
                            showObjectiveMenu();
                        }
                        saveAndRender();
                    }
                }
            }
        });
    })();
</script>
</body>
</html>
